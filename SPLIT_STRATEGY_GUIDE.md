# 코인원 분할매수 전략 가이드

## 전략 개요

### 매수 조건 (1차 매수 - 보유원화 30%)
- **RSI(9) 조건**: 직전 3봉 기울기 > 3, RSI(9) 값 < 70
- **RSI(9) EMA(5) 조건**: 직전 2봉 기울기 > 1
- **가격 EMA(5) 조건**: 직전 2봉 기울기 > 0.2

### 분할매수 구조
1. **1차 매수**: 매수 조건 만족시 30% 매수
2. **2차 매수**: 평균매수가 -2원에서 30% 매수
3. **3차 매수**: 평균매수가 -2원에서 40% + 미체결량 매수

### 매도 조건
- **익절**: 평균매수가 +3원 지정가 매도
- **손절**: 3차 매수 후 평균매수가 -2원 지정가 매도
- **시장가 매도**: 24시간 경과 또는 RSI(14) > 70

## 설치 및 실행 방법

### 1. API 키 설정
`config/api_keys.py` 파일 생성:
```python
# 코인원 API 키 설정
API_KEY = 'your_coinone_api_key'
SECRET_KEY = 'your_coinone_secret_key'
```

### 2. 필요한 패키지 설치
```bash
pip install pandas pandas-ta rich requests numpy matplotlib
```

### 3. 백테스트 실행
```bash
# Windows
test_split_backtest.bat

# 또는 직접 실행
python test_split_strategy.py
```

### 4. 실제 트레이딩 봇 실행
```bash
# Windows
run_split_strategy.bat

# 또는 직접 실행
python main_split_strategy.py
```

## 구현된 파일 구조

```
src/
├── indicators/
│   ├── rsi_short.py          # RSI(9) 및 RSI(9) EMA(5) 구현
│   ├── price_ema.py          # 가격 EMA(5) 구현
│   └── __init__.py           # 업데이트됨
├── strategy/
│   └── split_buy_strategy.py # 분할매수 전략 메인 로직
│
main_split_strategy.py        # 실시간 트레이딩 봇 (모니터링 포함)
test_split_strategy.py        # 백테스트 시스템
run_split_strategy.bat        # 윈도우 실행 스크립트
test_split_backtest.bat       # 백테스트 실행 스크립트
```

## 모니터링 대시보드

실시간 봇은 Rich 라이브러리를 사용한 터미널 UI를 제공합니다:

- **포지션 상태**: 현재 매수 단계, 평균가, 보유량
- **시장 조건**: 현재가, 각 지표별 조건 만족 여부
- **계좌 정보**: 보유 원화/USDT, 거래 통계
- **실시간 업데이트**: 30초마다 갱신

## 주요 특징

### 1. 엄격한 진입 조건
- 세 가지 지표가 모두 만족되어야 1차 매수 실행
- RSI(9) 기울기 임계값을 높게 설정하여 강한 모멘텀에서만 진입

### 2. 리스크 관리
- 분할매수로 평균가 개선 기회 제공
- 명확한 익절/손절 기준
- 24시간 시간 제한으로 장기 보유 방지

### 3. 소수점 올림 처리
- 모든 가격 계산에서 `math.ceil()` 사용
- 수량 계산시에도 올림 처리 적용

### 4. 포지션 상태 관리
- State Machine 패턴으로 명확한 상태 전환
- 미체결 주문 처리 로직 포함
- 부분체결시 10분 대기 후 미체결량 취소

## 백테스트 결과 해석

백테스트는 다음 지표를 제공합니다:
- **총 거래 수**: 전략이 실행된 총 거래 횟수
- **성공률**: 수익을 낸 거래의 비율
- **평균 수익률**: 거래당 평균 수익률
- **총 수익**: 전체 백테스트 기간의 누적 수익
- **보유 시간**: 평균 포지션 보유 시간

## 주의사항

### 1. 실거래 전 충분한 테스트
- 백테스트로 전략 검증 후 소액으로 테스트
- API 키는 거래 권한만 부여하고 출금 권한은 제외

### 2. 시장 상황 모니터링
- 급격한 시장 변동시 수동 개입 필요
- 봇 정지시 활성 포지션 수동 확인 필수

### 3. 자금 관리
- 전체 투자금의 일부만 봇에 할당
- 연속 손실시 봇 정지 고려

### 4. 시스템 안정성
- 24시간 가동을 위한 안정적인 서버 환경 필요
- 네트워크 연결 끊김에 대한 대비책 마련

## 성능 최적화 팁

1. **VPS 사용**: 24시간 안정적 운영을 위해 VPS 활용
2. **로그 모니터링**: 주기적으로 로그 파일 확인
3. **API 한도 관리**: 코인원 API 호출 한도 준수
4. **백업 계획**: 중요한 설정과 로그 파일 백업

## 문제 해결

### 일반적인 오류
- **API 연결 실패**: API 키 확인, 네트워크 상태 점검
- **잔고 부족**: 계좌 잔고 확인
- **주문 실패**: 최소 주문 금액, 가격 단위 확인

### 봇 재시작
- Ctrl+C로 안전하게 종료
- 활성 포지션 있을시 수동 확인 후 재시작

이 전략은 고빈도 거래가 아닌 기술적 조건 기반의 중장기 전략입니다. 충분한 테스트와 리스크 관리를 통해 안전하게 운영하시기 바랍니다.