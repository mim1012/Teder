# 매매 전략 구현 완료

State Machine 패턴을 사용한 코인원 USDT/KRW 자동매매 전략이 구현되었습니다.

## 구현된 주요 컴포넌트

### 1. TradingStrategy (src/strategy/trading_strategy.py)
메인 전략 클래스로 State Machine 패턴을 구현합니다.

**거래 상태:**
- `WAITING_FOR_BUY`: 매수 대기 상태
- `POSITION_HELD`: 포지션 보유 상태  
- `WAITING_FOR_SELL`: 매도 대기 상태
- `STRATEGY_COMPLETED`: 전략 완료 상태
- `ERROR`: 에러 상태

**주요 기능:**
- 실시간 RSI/EMA 지표 기반 매수 조건 확인
- 매도1호가 지정가 매수 주문
- 평균매수가 + 4원 익절 지정가 매도 주문
- 손절/청산 조건 확인 및 시장가 매도
- 부분 체결 처리 (10분 대기 후 미체결량 취소)

### 2. PositionManager (src/strategy/position_manager.py)
포지션 및 거래 관리를 담당합니다.

**주요 기능:**
- 평균매수가 계산
- 보유 수량 추적
- 실현/미실현 손익 계산
- 수익률 계산
- 포지션 타임아웃 확인 (24시간)
- 거래 통계 관리

### 3. OrderManager (src/strategy/order_manager.py)
주문 실행 및 관리를 담당합니다.

**주요 기능:**
- 지정가 매수/매도 주문
- 시장가 매도 주문 (청산용)
- 주문 상태 추적
- 부분 체결 대기 및 타임아웃 처리
- 미체결 주문 취소
- 활성 주문 관리

## 매수 조건 (모두 충족시 발동)

1. **RSI(14) 조건**: 직전 3봉과 5봉의 기울기가 모두 양수 (0.00 불포함)
2. **EMA(20) 조건**: 
   - 직전 3봉 기울기 >= 0.3
   - 직전 5봉 기울기 >= 0.2

## 매도 전략

### 익절 매도
- **조건**: 평균매수가 + 4원
- **방식**: 전량 지정가 매도
- **타이밍**: 매수 체결 즉시 주문

### 손절/청산 매도 (시장가 전량 매도)
1. 매수 후 24시간 경과시 익절 미체결
2. 실시간 RSI(14) > 70
3. EMA(20) 직전 3봉 기울기가 지속적으로 감소

## 실행 방법

### 1. 테스트 실행
```bash
python test_strategy.py
```

### 2. 메인 봇 실행
```bash
# 모의거래 (기본값)
python main.py --dry-run

# 실거래 (주의!)
python main.py --live

# 디버그 모드
python main.py --debug --dry-run
```

## 안전 장치

1. **모의거래 모드**: 기본적으로 DRY_RUN=True로 설정
2. **일일 거래 제한**: 최대 50회 거래 제한
3. **최대 주문 금액**: 1,000만원 제한
4. **긴급 정지**: emergency_stop 플래그
5. **연속 에러 감지**: 3회 연속 에러시 자동 중지
6. **graceful shutdown**: Ctrl+C 시그널 처리

## 모니터링 정보

실시간으로 다음 정보를 모니터링합니다:
- 현재 거래 상태
- 포지션 정보 (보유량, 평균매수가, 수익률)
- 활성 주문 상태
- RSI/EMA 지표 값
- 거래 통계 (총 거래수, 승률, 총 수익)

## 로그 관리

- 실시간 콘솔 출력
- 파일 로그 저장 (logs/trading_bot.log)
- 로그 레벨별 분류 (DEBUG, INFO, WARNING, ERROR)
- 자동 로그 로테이션

## 주요 특징

1. **State Machine 패턴**: 명확한 상태 관리와 전이
2. **부분 체결 처리**: 10분 대기 후 미체결량 자동 취소
3. **올림 처리**: 소수점 계산시 올림 처리 (요구사항)
4. **무한 반복**: 매수 → 매도 사이클의 연속 실행
5. **1시간 재시작 대기**: 전략 완료 후 1시간 대기
6. **에러 복구**: 에러 발생시 자동 정리 및 재시작

## 설정 파일

모든 설정은 `config/settings.py`에서 관리:
- 거래 설정 (수익 목표, 타임아웃 등)
- 기술적 지표 설정 (RSI, EMA 파라미터)
- 안전 설정 (거래 제한, 긴급 정지)
- 모니터링 설정 (로그 레벨, 업데이트 주기)

## 다음 단계

1. 백테스트 시스템 구축
2. 실시간 모니터링 UI 개발
3. 알림 시스템 구현
4. 성능 최적화
5. 배포 환경 구성